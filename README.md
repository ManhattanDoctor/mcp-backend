# MCP Backend - Мультисервисная платформа MCP серверов

## Описание

Этот проект представляет собой мультисервисную платформу, состоящую из нескольких MCP (Model Context Protocol) серверов, каждый из которых предоставляет специализированную функциональность. Платформа включает в себя серверы для работы с таможенными кодами ТН ВЭД и общие утилиты.

## Архитектура

Проект построен на модульной архитектуре с использованием NestJS и включает в себя:

### 1. TNVED Code Server (`tnved-code`)
Сервер для работы с таможенными кодами ТН ВЭД (Товарная номенклатура внешнеэкономической деятельности).

**Что такое ТН ВЭД?**
ТН ВЭД - это система классификации товаров, используемая для таможенного оформления и статистики внешней торговли. Каждый товар имеет уникальный код, который определяет его категорию, ставки пошлин и другие таможенные характеристики.

**Возможности:**
- **Поиск кодов**: Быстрый поиск таможенных кодов по описанию товара
- **Получение информации**: Детальная информация о конкретном коде
- **Гибридный поиск**: Комбинация текстового поиска (MiniSearch) и векторного поиска (Gnosis AI)
- **Нечеткий поиск**: Поиск работает даже с неточными или частичными запросами

### 2. Common Server (`common`)
Общий сервер с утилитарными функциями.

**Возможности:**
- **Текущая дата**: Получение текущей даты и времени
- **Базовые утилиты**: Общие функции для других серверов

## Технические возможности

- **MCP интеграция**: Легкая интеграция с AI-ассистентами и другими приложениями
- **Docker контейнеризация**: Каждый сервер упакован в отдельный Docker контейнер
- **CI/CD**: Автоматизированная сборка и развертывание через GitHub Actions
- **Модульная архитектура**: Легкое добавление новых серверов и функций

## Установка и запуск

### Требования

- Node.js (версия 20 или выше)
- npm или yarn
- Docker (для контейнеризации)

### Локальная разработка

#### Установка зависимостей

```bash
# Установка глобальных зависимостей
npm install

# Установка зависимостей для TNVED Code сервера
npm install --prefix ./src/packages/application/tnved-code

# Установка зависимостей для Common сервера
npm install --prefix ./src/packages/application/common
```

#### Запуск серверов

**TNVED Code Server:**
```bash
cd src/packages/application/tnved-code
npm start
# Сервер будет запущен на порту 31000
```

**Common Server:**
```bash
cd src/packages/application/common
npm start
# Сервер будет запущен на порту 31001
```

### Docker развертывание

#### Сборка образов

```bash
# Сборка образа TNVED Code сервера
docker build -f docker/tnved-code/Dockerfile -t mcp-tnved-code .

# Сборка образа Common сервера
docker build -f docker/common/Dockerfile -t mcp-common .
```

#### Запуск контейнеров

```bash
# Запуск TNVED Code сервера
docker run -d -p 31000:31000 -e WEB_PORT=31000 -e LOGGER_LEVEL=3 --name mcp-tnved-code mcp-tnved-code

# Запуск Common сервера
docker run -d -p 31001:31001 -e WEB_PORT=31001 -e LOGGER_LEVEL=3 --name mcp-common mcp-common
```

#### Использование готовых образов

```bash
# Получение образов из GitHub Container Registry
docker pull ghcr.io/manhattandoctor/mcp-backend/tnved-code:latest
docker pull ghcr.io/manhattandoctor/mcp-backend/common:latest
```

## Использование

### TNVED Code Server (Порт 31000)

#### Доступные инструменты

1. **customs_codes_search** - поиск таможенных кодов
   - Параметр: `query` (строка) - запрос для поиска
   - Параметр: `maximum` (число, опционально) - максимальное количество результатов (по умолчанию: 50)
   - Возвращает: список найденных кодов с оценкой релевантности
   - Особенности: Использует гибридный поиск (текстовый + векторный)

2. **customs_code_get** - получение конкретного кода
   - Параметр: `code` (строка) - код для получения
   - Возвращает: детальную информацию о коде

#### Примеры использования TNVED Code Server

**Поиск кодов по описанию:**
```
Запрос: "автомобили легковые"
Результат: список кодов, связанных с легковыми автомобилями с оценками релевантности
```

**Получение конкретного кода:**
```
Запрос: код "8703"
Результат: детальное описание кода 8703
```

**Поиск с ограничением результатов:**
```
Запрос: "мебель" с maximum: 10
Результат: до 10 наиболее релевантных кодов мебели
```

### Common Server (Порт 31001)

#### Доступные инструменты

1. **current_date_get** - получение текущей даты
   - Параметры: отсутствуют
   - Возвращает: текущую дату и время
   - Особенности: Идемпотентная операция, только для чтения

#### Примеры использования Common Server

**Получение текущей даты:**
```
Запрос: вызов current_date_get
Результат: { "date": "2024-01-15T10:30:00.000Z" }
```

## Технические детали

### Основные технологии

- **Фреймворк**: NestJS с TypeScript
- **Протокол**: MCP (Model Context Protocol) через @rekog/mcp-nest
- **Язык**: TypeScript (ESNext)
- **Платформа**: Node.js 20+

### Зависимости

**Глобальные зависимости:**
- `@nestjs/platform-express` - NestJS веб-платформа
- `@rekog/mcp-nest` - MCP интеграция для NestJS
- `@ts-core/backend` - Базовые утилиты бэкенда
- `@ts-core/backend-nestjs` - NestJS утилиты

**TNVED Code Server:**
- `minisearch` - Быстрый текстовый поиск
- `lodash` - Утилиты для работы с данными
- `zod` - Валидация схем

**Common Server:**
- `zod` - Валидация схем

### Поиск и данные

- **Текстовый поиск**: MiniSearch с нечетким поиском (fuzzy: 0.2)
- **Векторный поиск**: Gnosis AI API для семантического поиска
- **Гибридный поиск**: Комбинация текстового и векторного поиска
- **Данные**: Встроенная база данных ТН ВЭД кодов (~13,000 записей)

## Структура проекта

```
mcp-backend/
├── src/
│   └── packages/
│       ├── application/
│       │   ├── tnved-code/          # TNVED Code Server
│       │   │   ├── src/
│       │   │   │   ├── service/     # Сервисы для работы с данными
│       │   │   │   │   ├── Codes.ts # Сервис поиска кодов
│       │   │   │   │   └── InitializeService.ts
│       │   │   │   ├── tool/        # MCP инструменты
│       │   │   │   │   └── CodeTool.ts
│       │   │   │   ├── Data.ts      # База данных кодов (~13K записей)
│       │   │   │   ├── AppModule.ts # Модуль приложения
│       │   │   │   └── main.ts      # Точка входа
│       │   │   ├── package.json
│       │   │   └── tsconfig.json
│       │   └── common/              # Common Server
│       │       ├── src/
│       │       │   ├── service/     # Сервисы
│       │       │   │   └── InitializeService.ts
│       │       │   ├── tool/        # MCP инструменты
│       │       │   │   └── CurrentDateTool.ts
│       │       │   ├── AppModule.ts # Модуль приложения
│       │       │   └── main.ts      # Точка входа
│       │       └── package.json
│       └── module/                   # Общие модули
│           └── core/                 # Базовые утилиты
├── docker/
│   ├── tnved-code/                  # Docker конфигурация TNVED
│   │   └── Dockerfile
│   └── common/                      # Docker конфигурация Common
│       └── Dockerfile
├── .github/workflows/               # CI/CD конфигурация
│   ├── tnved-code-build.yml
│   ├── tnved-code-deploy.yml
│   ├── common-build.yml
│   └── common-deploy.yml
├── package.json                     # Глобальные зависимости
└── tsconfig.json                    # TypeScript конфигурация
```

## Настройка

### Переменные окружения

**TNVED Code Server:**
- `WEB_PORT` - порт сервера (по умолчанию: 31000)
- `WEB_HOST` - хост сервера (по умолчанию: localhost)
- `LOGGER_LEVEL` - уровень логирования (по умолчанию: 3)

**Common Server:**
- `WEB_PORT` - порт сервера (по умолчанию: 31001)
- `WEB_HOST` - хост сервера (по умолчанию: localhost)
- `LOGGER_LEVEL` - уровень логирования (по умолчанию: 3)

### Внешние сервисы

**Gnosis AI API:**
- Используется для векторного поиска в TNVED Code Server
- Требует API ключ (настроен в коде)
- Базовый URL: `https://api.gnosisai.ru/api`

## CI/CD

Проект использует GitHub Actions для автоматизированной сборки и развертывания:

### Workflow файлы

1. **tnved-code-build.yml** - Сборка и публикация образа TNVED Code сервера
2. **tnved-code-deploy.yml** - Развертывание TNVED Code сервера
3. **common-build.yml** - Сборка и публикация образа Common сервера
4. **common-deploy.yml** - Развертывание Common сервера

### Процесс сборки

1. Установка зависимостей
2. Компиляция TypeScript
3. Сборка Docker образа
4. Публикация в GitHub Container Registry

### Процесс развертывания

1. Остановка существующего контейнера
2. Получение нового образа из реестра
3. Запуск нового контейнера с обновленным образом

### Триггеры

- **Сборка**: Ручной запуск (workflow_dispatch)
- **Развертывание**: Ручной запуск (workflow_dispatch)

## Быстрый старт

### 1. Клонирование репозитория
```bash
git clone <repository-url>
cd mcp-backend
```

### 2. Установка зависимостей
```bash
npm install
npm install --prefix ./src/packages/application/tnved-code
npm install --prefix ./src/packages/application/common
```

### 3. Запуск серверов
```bash
# Терминал 1 - TNVED Code Server
cd src/packages/application/tnved-code
npm start

# Терминал 2 - Common Server  
cd src/packages/application/common
npm start
```

### 4. Проверка работы
- TNVED Code Server: http://localhost:31000
- Common Server: http://localhost:31001

### 5. Docker развертывание (альтернатива)
```bash
# Сборка и запуск через Docker
docker-compose up -d
```

## Лицензия

MIT License

## Автор

Renat Gubaev

## Мониторинг и логирование

### Логирование
- Все серверы используют структурированное логирование
- Уровень логирования настраивается через переменную `LOGGER_LEVEL`
- Логи включают информацию о запросах, ошибках и производительности

### Мониторинг
- Серверы предоставляют HTTP эндпоинты для проверки состояния
- Docker контейнеры можно мониторить через стандартные Docker команды
- GitHub Actions предоставляют информацию о статусе сборки и развертывания

## Разработка

### Добавление нового сервера
1. Создайте новую папку в `src/packages/application/`
2. Скопируйте структуру из существующих серверов
3. Обновите Docker конфигурацию
4. Добавьте GitHub Actions workflow
5. Обновите документацию

### Добавление нового инструмента
1. Создайте класс инструмента в папке `tool/`
2. Используйте декоратор `@Tool` для настройки MCP интерфейса
3. Добавьте валидацию схем с помощью Zod
4. Зарегистрируйте инструмент в `AppModule`

## Поддержка

Если у вас есть вопросы или проблемы:
- Создайте issue в репозитории проекта
- Проверьте логи серверов для диагностики
- Убедитесь, что все зависимости установлены корректно